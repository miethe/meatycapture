# ============================================================================
# MeatyCapture Docker Compose Configuration
# ============================================================================
#
# Production-ready Docker Compose setup for local deployment of the
# MeatyCapture application stack:
#   - Web App: React/Vite frontend (port 80 or WEB_PORT)
#   - REST API Server: Bun backend (port 3737 or via PORT env var)
#
# Quick Start:
#   1. Copy .env.example to .env and configure
#   2. Run: docker-compose up -d --build
#   3. View logs: docker-compose logs -f
#   4. Access web app: http://localhost
#   5. Access API: http://localhost:3737
#   6. Stop: docker-compose down
#
# Health Checks:
#   curl http://localhost/health           # Web app
#   curl http://localhost:3737/health      # API server
#
# Data Persistence:
#   Request-log markdown files are stored in ./data directory (mounted volume)
#
# ============================================================================

# ----------------------------------------------------------------------------
# Services
# ----------------------------------------------------------------------------
services:
  # MeatyCapture Web App (React/Vite Frontend)
  meatycapture-web:
    # Service name used for networking
    container_name: meatycapture-web

    # Build configuration
    build:
      context: .
      dockerfile: Dockerfile.web
      args:
        # API URL for the backend service (embedded at build time)
        # IMPORTANT: Must use HOST URL, not Docker service name, because
        # this is embedded in browser JS which runs on the user's machine
        MEATYCAPTURE_API_URL: ${MEATYCAPTURE_API_URL:-http://localhost:3737}

    # Image name for built container
    image: meatycapture-web:latest

    # Restart policy - restart unless manually stopped
    restart: unless-stopped

    # Port mapping: HOST:CONTAINER
    # Maps container port 80 to host port 80 (or 3000 if preferred)
    ports:
      - "${WEB_PORT:-80}:80"

    # Network configuration
    networks:
      - meatycapture-network

    # Dependencies - ensure backend starts first
    depends_on:
      meatycapture-server:
        condition: service_healthy

    # Health check configuration
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # MeatyCapture REST API Server (Bun Backend)
  meatycapture-server:
    # Service name used for networking
    container_name: meatycapture-server

    # Build configuration
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # Bun version (default: 1, can override for specific versions)
        BUN_VERSION: 1

    # Image name for built container
    image: meatycapture-server:latest

    # Restart policy - restart unless manually stopped
    # Options: no | always | on-failure | unless-stopped
    restart: unless-stopped

    # Port mapping: HOST:CONTAINER
    # Maps host port 3737 to container port (from PORT env var)
    # IMPORTANT: Container port must match PORT environment variable
    ports:
      - "3737:${PORT:-3001}"

    # Environment variables for runtime configuration
    # Values are loaded from .env file (see .env.example for reference)
    environment:
      # HTTP server port (must match EXPOSE in Dockerfile)
      PORT: ${PORT:-3001}

      # Environment mode: production | development
      NODE_ENV: ${NODE_ENV:-production}

      # Logging verbosity: debug | info | warn | error
      LOG_LEVEL: ${LOG_LEVEL:-info}

      # Data directory inside container (mounted volume)
      MEATYCAPTURE_DATA_DIR: ${MEATYCAPTURE_DATA_DIR:-/data}

      # CORS allowed origins (comma-separated)
      # Default allows common dev ports; override in .env for production
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:5173,http://localhost:4173,http://localhost:3000}

      # Optional: Authentication token for API access
      # Uncomment in .env to enable authentication
      MEATYCAPTURE_AUTH_TOKEN: ${MEATYCAPTURE_AUTH_TOKEN:-}

    # Environment file for sensitive/complex configuration
    # This file should not be committed to git
    env_file:
      - .env

    # Volume mounts for persistent data storage
    volumes:
      # Mount local ./data directory to container's /data directory
      # This persists request-log files, project metadata, and field catalogs
      # Format: HOST_PATH:CONTAINER_PATH:OPTIONS
      - ./data:/data

      # Alternative: Use named volume for better Docker management
      # Uncomment below and comment out ./data mount to use named volume
      # - meatycapture-data:/data

    # Health check configuration
    # Uses the built-in HEALTHCHECK from Dockerfile
    # The service is considered healthy when /health endpoint returns 200 OK
    healthcheck:
      # Health check is defined in Dockerfile:
      # - Interval: 30s (check every 30 seconds)
      # - Timeout: 5s (fail if check takes > 5 seconds)
      # - Start period: 10s (grace period on startup)
      # - Retries: 3 (mark unhealthy after 3 consecutive failures)
      # Uses PORT env var to match server binding
      test: ["CMD", "bun", "run", "-e", "fetch('http://localhost:' + (process.env.PORT || 3001) + '/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    # Network configuration
    networks:
      - meatycapture-network

    # Resource limits (optional, uncomment for production)
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '1'
    #       memory: 512M
    #     reservations:
    #       cpus: '0.5'
    #       memory: 256M

# ----------------------------------------------------------------------------
# Networks
# ----------------------------------------------------------------------------
networks:
  # Bridge network for service isolation
  # Allows containers to communicate internally while controlling external access
  meatycapture-network:
    driver: bridge
    name: meatycapture-network

# ----------------------------------------------------------------------------
# Volumes (Optional Named Volumes)
# ----------------------------------------------------------------------------
# Uncomment to use Docker-managed named volumes instead of bind mounts
# Named volumes provide better portability and backup management
# volumes:
#   meatycapture-data:
#     name: meatycapture-data
#     driver: local
